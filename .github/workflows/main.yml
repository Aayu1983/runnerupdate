name: Weekly Windows Self-Hosted Runner Update

on:
  schedule:
    # Every day at 19:20 IST
    - cron: '50 13 * * *'
  workflow_dispatch:

permissions:  
  id-token: write   # typo fix: wright â†’ write
  contents: read 

jobs:
  update-runner:
    name: Update Windows Self-Hosted Runner
    runs-on: [self-hosted, windows]

    steps:
      - name: Show current runner version
        shell: powershell
        run: |
          # Navigate to runner folder and show version
          Set-Location 'C:\actions-runner'
          .\config.cmd --version

      - name: Stop GitHub Actions runner service
        shell: powershell
        run: |
          Get-Service | Where-Object {$_.Name -like "actions.runner*"} | Stop-Service -Force

      - name: Update GitHub Actions runner
        shell: powershell
        run: |
          Set-Location 'C:\actions-runner'
          .\run.cmd --update

      - name: Start GitHub Actions runner service
        shell: powershell
        run: |
          Get-Service | Where-Object {$_.Name -like "actions.runner*"} | Start-Service

      - name: Install Windows Updates
        shell: powershell
        run: |
          Install-Module PSWindowsUpdate -Force -Confirm:$false
          Import-Module PSWindowsUpdate
          # Install all updates without reboot
          Get-WindowsUpdate -Install -AcceptAll -IgnoreReboot

      - name: Reboot if required
        shell: powershell
        run: |
          if (Get-WURebootStatus -Silent) {
            Write-Output "Reboot required. Restarting..."
            Restart-Computer -Force
          } else {
            Write-Output "No reboot required."
          }
