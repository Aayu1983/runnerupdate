name: Weekly Windows Self-Hosted Runner Update

on:
  # Schedule: Every day at 19:20 IST (13:50 UTC)
  schedule:
    - cron: '50 13 * * *'
  # Allow manual trigger
  workflow_dispatch:

permissions:  
  id-token: write
  contents: read 

jobs:
  update-runner:
    name: Update Windows Self-Hosted Runner
    runs-on: [self-hosted, windows] # Must run on Windows self-hosted runner

    steps:
      - name: Show OS
        shell: powershell
        run: |
          Write-Output "Running on:"
          [System.Environment]::OSVersion

      - name: Show current runner version
        shell: powershell
        run: |
          # Navigate to runner folder and show version
          Set-Location 'C:\actions-runner'
          .\config.cmd --version

      - name: Stop GitHub Actions runner service
        shell: powershell
        run: |
          # Stop all runner services before update
          Get-Service | Where-Object {$_.Name -like "actions.runner*"} | Stop-Service -Force

      - name: Update GitHub Actions runner
        shell: powershell
        run: |
          Set-Location 'C:\actions-runner'
          .\run.cmd --update

      - name: Start GitHub Actions runner service
        shell: powershell
        run: |
          Get-Service | Where-Object {$_.Name -like "actions.runner*"} | Start-Service

      - name: Install Windows Updates
        shell: powershell
        run: |
          # Install PSWindowsUpdate module if not already installed
          if (-not (Get-Module -ListAvailable -Name PSWindowsUpdate)) {
              Install-Module PSWindowsUpdate -Force -Confirm:$false
          }
          Import-Module PSWindowsUpdate
          # Install all available updates without reboot
